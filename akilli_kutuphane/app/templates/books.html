{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h2 class="fw-bold text-primary">ğŸ“š KÃ¼tÃ¼phane ArÅŸivi</h2>
            <p class="text-muted">Binlerce kitap arasÄ±nda keÅŸfe Ã§Ä±kÄ±n.</p>
        </div>
        
        <div class="col-md-6">
            <div class="input-group shadow-sm">
                <input type="text" id="searchInput" class="form-control" placeholder="Kitap adÄ± veya yazar ara...">
                <button class="btn btn-primary" type="button" onclick="searchBooks()">
                    ğŸ” Ara
                </button>
            </div>
        </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-4 justify-content-center">
        <button class="btn btn-outline-secondary rounded-pill px-4 active-category" onclick="filterCategory('TÃ¼mÃ¼', this)">TÃ¼mÃ¼</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterCategory('Roman', this)">Roman</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterCategory('Tarih', this)">Tarih</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterCategory('Bilim', this)">Bilim</button>
        <button class="btn btn-outline-secondary rounded-pill px-4" onclick="filterCategory('Klasik', this)">Klasik</button>
    </div>

    <hr class="text-muted">

    <div id="booksContainer" class="row g-4">
        <div class="text-center w-100 mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">YÃ¼kleniyor...</span>
            </div>
            <p class="mt-2 text-muted">Kitaplar raflardan getiriliyor...</p>
        </div>
    </div>

</div>

<script>
    // 1. SAYFA YÃœKLENÄ°NCE Ã‡ALIÅIR
    document.addEventListener("DOMContentLoaded", () => {
        loadBooks(); // TÃ¼m kitaplarÄ± getir
        
        // "Enter" tuÅŸuna basÄ±nca da arama yapsÄ±n
        document.getElementById('searchInput').addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                searchBooks();
            }
        });
    });

    // 2. KÄ°TAPLARI SUNUCUDAN Ã‡EKEN FONKSÄ°YON
    async function loadBooks(category = "TÃ¼mÃ¼", searchQuery = "") {
        const container = document.getElementById('booksContainer');
        
        // YÃ¼kleniyor simgesi gÃ¶ster
        container.innerHTML = `
            <div class="text-center w-100 py-5">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 text-muted">AranÄ±yor...</p>
            </div>`;
        
        try {
            // URL OLUÅTURMA
            let url = `/api/books/?cat=${encodeURIComponent(category)}`;
            
            // EÄŸer arama kelimesi varsa URL'ye ekle
            if(searchQuery && searchQuery.trim() !== "") {
                url += `&q=${encodeURIComponent(searchQuery)}`;
            }

            console.log("Ä°stek gÃ¶nderiliyor:", url); // Hata ayÄ±klama iÃ§in konsola yaz

            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error("Sunucu baÄŸlantÄ± hatasÄ±: " + response.status);
            }

            const books = await response.json();
            container.innerHTML = ''; // Temizle

            // HÄ°Ã‡ KÄ°TAP YOKSA
            if (books.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning text-center p-5 shadow-sm">
                            <h4>ğŸ˜” SonuÃ§ BulunamadÄ±</h4>
                            <p>AradÄ±ÄŸÄ±nÄ±z kriterlere uygun kitap stoklarÄ±mÄ±zda yok.</p>
                            <button class="btn btn-outline-dark mt-2" onclick="filterCategory('TÃ¼mÃ¼')">TÃ¼m KitaplarÄ± GÃ¶ster</button>
                        </div>
                    </div>`;
                return;
            }

            // KÄ°TAPLARI KART OLARAK YAZDIR
            books.forEach(book => {
                // Stok durumuna gÃ¶re renk ve yazÄ±
                let stokRozet = book.stok > 0 
                    ? `<span class="badge bg-success">Stok: ${book.stok}</span>` 
                    : `<span class="badge bg-danger">TÃ¼kendi</span>`;
                
                let butonDurum = book.stok > 0 ? '' : 'disabled';
                let butonMetin = book.stok > 0 ? 'ğŸ“– Ã–dÃ¼nÃ§ Al' : 'âŒ Stok Yok';

                const html = `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm border-0 hover-card">
                        <div class="card-header bg-transparent border-0 d-flex justify-content-between pt-3">
                            <span class="badge bg-light text-dark border">${book.kategori}</span>
                            ${stokRozet}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title fw-bold text-dark mb-1">${book.ad}</h5>
                            <p class="card-text text-muted small fst-italic mb-3">${book.yazar}</p>
                            <hr class="my-2 opacity-25">
                            <p class="small text-muted mb-0">Durum: <span class="fw-semibold">${book.durum}</span></p>
                        </div>
                        <div class="card-footer bg-transparent border-0 pb-3">
                            <button onclick="borrowBook(${book.id})" 
                                    class="btn btn-primary w-100 rounded-3" ${butonDurum}>
                                ${butonMetin}
                            </button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += html;
            });

        } catch (error) {
            console.error("Hata:", error);
            container.innerHTML = `<div class="alert alert-danger w-100 text-center">Bir hata oluÅŸtu: ${error.message}</div>`;
        }
    }

    // 3. ARAMA BUTONU FONKSÄ°YONU
    function searchBooks() {
        const query = document.getElementById('searchInput').value;
        // Arama yaparken kategoriyi sÄ±fÄ±rla veya mevcut kategoride ara (Åimdilik TÃ¼mÃ¼'nde arÄ±yoruz)
        loadBooks("TÃ¼mÃ¼", query);
    }

    // 4. KATEGORÄ° BUTONU FONKSÄ°YONU
    function filterCategory(categoryName, btnElement) {
        // Arama kutusunu temizle
        const searchBox = document.getElementById('searchInput');
        if(searchBox) searchBox.value = "";
        
        // Buton renklerini gÃ¼ncelle (GÃ¶rsel efekt)
        if(btnElement) {
            document.querySelectorAll('.btn-group button, .d-flex button').forEach(btn => {
                btn.classList.remove('btn-dark', 'text-white');
                btn.classList.add('btn-outline-secondary');
            });
            btnElement.classList.remove('btn-outline-secondary');
            btnElement.classList.add('btn-dark', 'text-white');
        }

        loadBooks(categoryName);
    }

    // 5. Ã–DÃœNÃ‡ ALMA FONKSÄ°YONU (Token KontrollÃ¼)
    async function borrowBook(bookId) {
        const token = localStorage.getItem('token');
        if (!token) {
            if(confirm("Bu iÅŸlem iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z. GiriÅŸ sayfasÄ±na gitmek ister misiniz?")) {
                window.location.href = '/login';
            }
            return;
        }

        if(!confirm("Bu kitabÄ± Ã¶dÃ¼nÃ§ almak istediÄŸinize emin misiniz?")) return;

        try {
            const res = await fetch('/api/loans/borrow', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token 
                },
                body: JSON.stringify({ book_id: bookId })
            });

            const data = await res.json();
            
            if(res.ok) {
                alert("âœ… " + (data.message || "Ä°ÅŸlem BaÅŸarÄ±lÄ±!"));
                loadBooks(); // Listeyi yenile (Stok dÃ¼ÅŸsÃ¼n)
            } else {
                alert("âŒ Hata: " + (data.msg || data.error || "Bilinmeyen Hata"));
            }
        } catch(e) { 
            console.error(e);
            alert("Sunucu ile iletiÅŸim kurulamadÄ±!"); 
        }
    }
</script>

<style>
    .hover-card { transition: transform 0.2s; }
    .hover-card:hover { transform: translateY(-5px); }
</style>
{% endblock %}