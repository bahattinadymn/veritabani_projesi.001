{% extends "base.html" %}

{% block content %}
<style>
    /* Profil SayfasÄ± Ã–zel TasarÄ±mÄ± */
    .profile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        padding: 40px 20px;
        text-align: center;
    }

    .profile-img {
        width: 100px;
        height: 100px;
        background-color: white;
        border-radius: 50%;
        padding: 5px;
        margin-top: -50px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .stat-card {
        transition: transform 0.2s;
        border: none;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .table-custom th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #555;
    }

    .table-custom td {
        vertical-align: middle;
    }
</style>

<div class="row mt-4">
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="profile-header">
                <h4 class="mb-0">Ã–ÄŸrenci PortalÄ±</h4>
            </div>

            <div class="card-body text-center">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="User" class="profile-img mb-3">

                <h3 id="userName" class="fw-bold mb-1">YÃ¼kleniyor...</h3>
                <span class="badge bg-primary px-3 py-2 rounded-pill">ğŸ“ KTÃœ Ã–ÄŸrencisi</span>

                <hr class="my-4">

                <div class="d-flex justify-content-around text-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-0" id="okunanSayisi">-</h5>
                        <small class="text-muted">Okunan</small>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-0 text-success">A+</h5>
                        <small class="text-muted">Puan</small>
                    </div>
                </div>
                <button type="button" class="btn btn-outline-secondary w-100 rounded-pill mb-2" data-bs-toggle="modal"
                    data-bs-target="#settingsModal">
                    âš™ï¸ Ayarlar & Åifre
                </button>

                <button onclick="logout()" class="btn btn-outline-danger w-100 rounded-pill">
                    GÃ¼venli Ã‡Ä±kÄ±ÅŸ Yap
                </button>
            </div>
        </div>
    </div>

    <div class="col-lg-8">

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card stat-card p-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white p-3 rounded-circle me-3">ğŸ“š</div>
                        <div>
                            <h6 class="text-muted mb-0">Aktif Ã–dÃ¼nÃ§</h6>
                            <h4 class="fw-bold mb-0" id="activeLoanCount">0 Kitap</h4>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card stat-card p-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-success text-white p-3 rounded-circle me-3">ğŸ“…</div>
                        <div>
                            <h6 class="text-muted mb-0">Son Ä°ade Tarihi</h6>
                            <h4 class="fw-bold mb-0" id="lastDate">-</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-header bg-white py-3 border-0">
                <h5 class="mb-0 text-primary fw-bold">ğŸ“– Elimdeki Kitaplar</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Kitap Bilgisi</th>
                                <th>AlÄ±ÅŸ Tarihi</th>
                                <th>Durum (Kalan GÃ¼n)</th>
                                <th class="text-end pe-4">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="loansTable">
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">Veriler yÃ¼kleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-danger fw-bold">âš ï¸ Ceza ve Ã–deme GeÃ§miÅŸi</h5>
                <span class="badge bg-danger rounded-pill fs-6" id="totalDebtDisplay">0.00 TL</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-custom table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="ps-4">Kitap</th>
                                <th>AÃ§Ä±klama</th>
                                <th>Tarih</th>
                                <th class="text-end pe-4">Tutar</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">YÃ¼kleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-bold">âš™ï¸ Hesap AyarlarÄ±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body p-4">
        <form id="passwordForm">
            <div class="mb-3">
                <label class="form-label text-muted small">Mevcut Åifreniz</label>
                <input type="password" id="oldPass" class="form-control" placeholder="****">
            </div>
            <div class="mb-3">
                <label class="form-label text-muted small">Yeni Åifre</label>
                <input type="password" id="newPass" class="form-control" placeholder="****">
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Åifreyi GÃ¼ncelle</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    // SAYFA YÃœKLENDÄ°ÄÄ°NDE TÃœM VERÄ°LERÄ° Ã‡EK
    document.addEventListener("DOMContentLoaded", function () {
        loadMyLoans();  // Aktif kitaplar
        loadStats();    // Ä°statistikler (Okunan sayÄ±sÄ± vb.)
        loadHistory();  // Ceza GeÃ§miÅŸi
    });

    // 1. AKTÄ°F KÄ°TAPLARI VE KULLANICI ADINI YÃœKLE
    async function loadMyLoans() {
        const user = JSON.parse(localStorage.getItem('user'));
        if (user) document.getElementById('userName').textContent = user.ad + ' ' + user.soyad;

        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        try {
            const response = await fetch('/api/loans/my', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const loans = await response.json();

            // Aktif kitap sayÄ±sÄ±nÄ± gÃ¼ncelle
            document.getElementById('activeLoanCount').textContent = loans.length + ' Kitap';

            // NOT: Okunan kitap sayÄ±sÄ±nÄ± buradan GÃœNCELLEMÄ°YORUZ. loadStats fonksiyonu yapacak.

            const tbody = document.getElementById('loansTable');
            tbody.innerHTML = '';

            if (loans.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-5">
                            <div class="text-muted">
                                <span style="font-size: 40px;">ğŸ“­</span><br>
                                Åu an Ã¶dÃ¼nÃ§ aldÄ±ÄŸÄ±nÄ±z kitap yok.<br>
                                <a href="/books" class="btn btn-sm btn-primary mt-2">Kitaplara GÃ¶z At</a>
                            </div>
                        </td>
                    </tr>`;
                document.getElementById('lastDate').textContent = "Yok";
                return;
            }

            let minDate = null;

            loans.forEach(loan => {
                const today = new Date();
                const due = new Date(loan.son_teslim);
                const diffTime = due - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (!minDate || due < minDate) minDate = due;

                let badgeHtml = '';
                if (diffDays < 0) {
                    badgeHtml = `<span class="badge bg-danger">GecikmiÅŸ (${Math.abs(diffDays)} gÃ¼n)</span>`;
                } else if (diffDays <= 3) {
                    badgeHtml = `<span class="badge bg-warning text-dark">${diffDays} gÃ¼n kaldÄ±</span>`;
                } else {
                    badgeHtml = `<span class="badge bg-success">Sorun Yok (${diffDays} gÃ¼n)</span>`;
                }

                const row = `
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="bg-light p-2 rounded me-3" style="font-size:20px;">ğŸ“˜</div>
                                <div>
                                    <div class="fw-bold text-dark">${loan.kitap_adi}</div>
                                    <small class="text-muted">${loan.yazar}</small>
                                </div>
                            </div>
                        </td>
                        <td>${loan.alis_tarihi}</td>
                        <td>${badgeHtml}</td>
                        <td class="text-end pe-4">
                            <button onclick="returnBook(${loan.loan_id})" class="btn btn-sm btn-outline-success px-3 rounded-pill shadow-sm">
                                ğŸ”„ Ä°ade Et
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            if (minDate) {
                document.getElementById('lastDate').textContent = minDate.toLocaleDateString('tr-TR');
            }

        } catch (error) {
            console.error(error);
        }
    }

    // 2. Ä°STATÄ°STÄ°KLERÄ° YÃœKLE (OKUNAN KÄ°TAP SAYISI BURADAN GELÄ°R)
    async function loadStats() {
        const token = localStorage.getItem('token');
        try {
            const res = await fetch('/api/loans/stats', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();

            // Okunan SayÄ±sÄ±nÄ± Backend'den gelen gerÃ§ek veriyle deÄŸiÅŸtir
            if (document.getElementById('okunanSayisi'))
                document.getElementById('okunanSayisi').innerText = data.okunan;

            // Toplam cezayÄ± gÃ¼ncelle
            if (document.getElementById('totalDebtDisplay'))
                document.getElementById('totalDebtDisplay').innerText = data.toplam_ceza + ' TL';

        } catch (error) {
            console.error("Ä°statistik yÃ¼klenemedi", error);
        }
    }

    // 3. CEZA VE Ã–DEME GEÃ‡MÄ°ÅÄ°NÄ° YÃœKLE
    async function loadHistory() {
        const token = localStorage.getItem('token');
        const tableBody = document.getElementById('historyTableBody');

        try {
            // Backend'de oluÅŸturduÄŸumuz yeni rota: /api/loans/history
            const res = await fetch('/api/loans/history', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const history = await res.json();

            tableBody.innerHTML = '';

            if (history.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">GeÃ§miÅŸ ceza kaydÄ± bulunmamaktadÄ±r.</td></tr>';
                return;
            }

            history.forEach(item => {
                const row = `
                    <tr>
                        <td class="ps-4"><span class="fw-bold text-dark">${item.kitap_adi}</span></td>
                        <td>${item.aciklama}</td>
                        <td>${item.tarih}</td>
                        <td class="text-end pe-4"><span class="badge bg-danger">-${item.tutar} TL</span></td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

        } catch (error) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">GeÃ§miÅŸ verileri yÃ¼klenemedi.</td></tr>';
        }
    }

    // 4. KÄ°TAP Ä°ADE ETME
    async function returnBook(loanId) {
        if (!confirm("Bu kitabÄ± kÃ¼tÃ¼phaneye iade etmek istiyor musunuz?")) return;

        const token = localStorage.getItem('token');
        try {
            const response = await fetch('/api/loans/return', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ loan_id: loanId })
            });

            const data = await response.json();

            if (response.ok) {
                alert("âœ… " + data.message);
                // Sayfadaki tÃ¼m verileri yenile
                loadMyLoans();
                loadStats();
                loadHistory();
            } else {
                alert("Hata: " + data.msg);
            }
        } catch (e) { console.error(e); }
    }

    function logout() {
        if (confirm("Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?")) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
    }
    
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault(); // Sayfa yenilenmesini engelle
        
        const oldPass = document.getElementById('oldPass').value;
        const newPass = document.getElementById('newPass').value;
        const token = localStorage.getItem('token');

        if(!oldPass || !newPass) {
            alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun.");
            return;
        }

        try {
            const res = await fetch('/api/auth/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ 
                    eski_sifre: oldPass, 
                    yeni_sifre: newPass 
                })
            });

            const data = await res.json();

            if (res.ok) {
                alert(data.message);
                // ModalÄ± kapat
                var myModalEl = document.getElementById('settingsModal');
                var modal = bootstrap.Modal.getInstance(myModalEl);
                modal.hide();
                
                // Formu temizle
                document.getElementById('passwordForm').reset();
            } else {
                alert("Hata: " + data.msg);
            }
        } catch (error) {
            console.error(error);
            alert("Bir hata oluÅŸtu.");
        }
    });
</script>
{% endblock %}